<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Classification Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- D3.js for wordcloud and network visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- D3 Wordcloud -->
    <script src="https://cdn.jsdelivr.net/gh/jasondavies/d3-cloud@1.2.5/build/d3.layout.cloud.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- ForceGraph for network visualization -->
    <script src="https://unpkg.com/force-graph"></script>
    <!-- jLouvain for community detection in networks -->
    <script src="https://unpkg.com/jlouvain@2.0.0/build/jlouvain.min.js"></script>
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .wordcloud {
            width: 100%;
            height: 400px;
        }
        .chart-container {
            height: 400px;
        }
        .tab-content {
            padding: 20px;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
        }
        .filter-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            text-align: center;
            padding-top: 20%;
        }
        .sample-data-button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Processing data...</p>
    </div>

    <div class="container">
        <h1 class="text-center mb-4">Company Classification Dashboard</h1>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Data Import</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Upload CSV file with classification data:</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="csvFile" accept=".csv">
                                <button class="btn btn-success" id="loadCsvBtn" type="button">Load Data</button>
                                <button class="btn btn-info sample-data-button" id="loadSampleBtn" type="button">Load Sample Data</button>
                            </div>
                            <small class="text-muted">Expected columns: Company Name, Company URL, vertical, vertical_detail</small>
                        </div>
                        <div id="uploadStatus" class="alert alert-info d-none"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardContent" class="d-none">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">Filters</h5>
                        </div>
                        <div class="card-body filter-container">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="verticalFilter" class="form-label">Vertical Category:</label>
                                    <select class="form-select" id="verticalFilter">
                                        <option value="all">All Verticals</option>
                                        <optgroup label="BIOTECH/LIFE SCIENCES VERTICALS">
                                            <option value="Therapeutics">Therapeutics</option>
                                            <option value="Research Tools & Lab Equipment">Research Tools & Lab Equipment</option>
                                            <option value="Diagnostics">Diagnostics</option>
                                            <option value="Medical Devices">Medical Devices</option>
                                            <option value="CROs & CDMOs">CROs & CDMOs</option>
                                            <option value="Bioinformatics & Computational Tools">Bioinformatics & Computational Tools</option>
                                            <option value="Digital Health & Health IT">Digital Health & Health IT</option>
                                            <option value="Clinical & Regulatory Consulting">Clinical & Regulatory Consulting</option>
                                            <option value="General Biotech">General Biotech</option>
                                            <option value="Industrial Biotech">Industrial Biotech</option>
                                        </optgroup>
                                        <optgroup label="ACADEMIC VERTICAL">
                                            <option value="Academic & Research Institutions">Academic & Research Institutions</option>
                                        </optgroup>
                                        <optgroup label="NON-BIOTECH VERTICALS">
                                            <option value="Healthcare Services">Healthcare Services</option>
                                            <option value="Technology/IT">Technology/IT</option>
                                            <option value="Professional Services">Professional Services</option>
                                            <option value="Manufacturing">Manufacturing</option>
                                            <option value="Consumer Goods">Consumer Goods</option>
                                            <option value="Financial Services">Financial Services</option>
                                            <option value="Energy">Energy</option>
                                            <option value="Media & Entertainment">Media & Entertainment</option>
                                            <option value="Government & Public Sector">Government & Public Sector</option>
                                            <option value="Environmental Services">Environmental Services</option>
                                            <option value="Real Estate & Construction">Real Estate & Construction</option>
                                            <option value="Education & Training">Education & Training</option>
                                            <option value="Transportation & Logistics">Transportation & Logistics</option>
                                            <option value="Non-Profit & Advocacy">Non-Profit & Advocacy</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label for="detailSearch" class="form-label">Search in Vertical Details:</label>
                                    <input type="text" class="form-control" id="detailSearch" placeholder="Enter keywords (e.g., 'antibody', 'cancer', 'platform')">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
                                    <button class="btn btn-secondary" id="resetFiltersBtn">Reset Filters</button>
                                    <span class="ms-3" id="resultsCount"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab" aria-controls="data" aria-selected="true">Data Table</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab" aria-controls="charts" aria-selected="false">Charts</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="wordcloud-tab" data-bs-toggle="tab" data-bs-target="#wordcloud" type="button" role="tab" aria-controls="wordcloud" aria-selected="false">Word Cloud</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights" type="button" role="tab" aria-controls="insights" aria-selected="false">Insights</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">Advanced Analysis</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network" type="button" role="tab" aria-controls="network" aria-selected="false">Network Analysis</button>
                </li>
            </ul>
            
            <div class="tab-content" id="dashboardTabsContent">
                <!-- Data Table Tab -->
                <div class="tab-pane fade show active" id="data" role="tabpanel" aria-labelledby="data-tab">
                    <div class="table-responsive">
                        <table id="companiesTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>Company Name</th>
                                    <th>URL</th>
                                    <th>Vertical</th>
                                    <th>Vertical Detail</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Charts Tab -->
                <div class="tab-pane fade" id="charts" role="tabpanel" aria-labelledby="charts-tab">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Companies by Vertical</h5>
                                </div>
                                <div class="card-body chart-container">
                                    <canvas id="verticalChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Category Distribution</h5>
                                </div>
                                <div class="card-body chart-container">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Top Terms in Vertical Details</h5>
                                </div>
                                <div class="card-body chart-container">
                                    <canvas id="termsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Word Cloud Tab -->
                <div class="tab-pane fade" id="wordcloud" role="tabpanel" aria-labelledby="wordcloud-tab">
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Vertical Details Word Cloud</h5>
                                </div>
                                <div class="card-body wordcloud-container">
                                    <div id="detailsWordcloud" class="wordcloud"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Biotech Verticals Word Cloud</h5>
                                </div>
                                <div class="card-body wordcloud-container">
                                    <div id="biotechWordcloud" class="wordcloud"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Non-Biotech Verticals Word Cloud</h5>
                                </div>
                                <div class="card-body wordcloud-container">
                                    <div id="nonBiotechWordcloud" class="wordcloud"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Insights Tab -->
                <div class="tab-pane fade" id="insights" role="tabpanel" aria-labelledby="insights-tab">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Key Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <div id="keyStats">
                                        <!-- Stats will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Common Terms by Vertical</h5>
                                </div>
                                <div class="card-body">
                                    <div id="verticalTerms">
                                        <select class="form-select mb-3" id="verticalTermsSelect">
                                            <!-- Options will be inserted here -->
                                        </select>
                                        <div id="verticalTermsList"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Analysis Tab -->
                <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Vertical Detail Length by Category</h5>
                                </div>
                                <div class="card-body chart-container">
                                    <canvas id="detailLengthChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Vertical Comparison</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Select verticals to compare:</label>
                                        <div class="d-flex">
                                            <select class="form-select me-2" id="compareVertical1">
                                                <!-- Options will be inserted here -->
                                            </select>
                                            <select class="form-select" id="compareVertical2">
                                                <!-- Options will be inserted here -->
                                            </select>
                                        </div>
                                        <button class="btn btn-primary mt-2" id="compareVerticalsBtn">Compare</button>
                                    </div>
                                    <div id="comparisonResult" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Term Distribution Across Verticals</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Search for a term:</label>
                                        <div class="d-flex">
                                            <input type="text" class="form-control me-2" id="termSearch" placeholder="Enter term (e.g., 'therapy', 'platform')">
                                            <button class="btn btn-primary" id="searchTermBtn">Search</button>
                                        </div>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="termDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Vertical Detail Sentiment Analysis</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        This chart shows an estimated sentiment score calculated based on the presence of positive and negative words in vertical details.
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="sentimentChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Network Analysis Tab -->
                <div class="tab-pane fade" id="network" role="tabpanel" aria-labelledby="network-tab">
                    <div class="row">
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Term Co-occurrence Network</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        This visualization shows how frequently terms appear together in company descriptions. Larger nodes represent more common terms, and thicker edges indicate stronger relationships.
                                    </div>
                                    <div id="networkGraph" style="height: 600px; background-color: #f8f9fa;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Vertical Similarity Map</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        This visualization shows how similar different verticals are based on the common terms used in their descriptions.
                                    </div>
                                    <div id="verticalClusterMap" style="height: 400px; background-color: #f8f9fa;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Term Clusters</h5>
                                </div>
                                <div class="card-body">
                                    <div id="termClusters"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Dashboard JS -->
    <script>
        // Global variables
        let companiesData = [];
        let filteredData = [];
        let dataTable;
        let verticalChart, categoryChart, termsChart;
        let detailsWordcloud, biotechWordcloud, nonBiotechWordcloud;

        // Define vertical categories
        const biotechVerticals = [
            "Therapeutics",
            "Research Tools & Lab Equipment",
            "Diagnostics",
            "Medical Devices",
            "CROs & CDMOs",
            "Bioinformatics & Computational Tools",
            "Digital Health & Health IT",
            "Clinical & Regulatory Consulting",
            "General Biotech",
            "Industrial Biotech"
        ];
        
        const academicVerticals = [
            "Academic & Research Institutions"
        ];
        
        const nonBiotechVerticals = [
            "Healthcare Services",
            "Technology/IT",
            "Professional Services",
            "Manufacturing",
            "Consumer Goods",
            "Financial Services",
            "Energy",
            "Media & Entertainment",
            "Government & Public Sector",
            "Environmental Services",
            "Real Estate & Construction",
            "Education & Training",
            "Transportation & Logistics",
            "Non-Profit & Advocacy"
        ];

        // Initialize DataTable
        function initDataTable() {
            if (dataTable) {
                dataTable.destroy();
            }
            
            dataTable = $('#companiesTable').DataTable({
                data: filteredData,
                columns: [
                    { 
                        data: 'Company Name',
                        render: function(data, type, row) {
                            if (type === 'display' && row['Company URL'] && row['Company URL'] !== 'No URL found' && row['Company URL'] !== 'Error') {
                                return '<a href="' + row['Company URL'] + '" target="_blank">' + data + '</a>';
                            }
                            return data;
                        }
                    },
                    { 
                        data: 'Company URL',
                        render: function(data, type, row) {
                            if (type === 'display' && data && data !== 'No URL found' && data !== 'Error') {
                                return '<a href="' + data + '" target="_blank">' + data + '</a>';
                            }
                            return data;
                        }
                    },
                    { data: 'vertical' },
                    { data: 'vertical_detail' }
                ],
                pageLength: 25,
                lengthMenu: [10, 25, 50, 100],
                responsive: true,
                dom: 'Bfrtip',
                buttons: ['copy', 'csv', 'excel']
            });
        }

        // Initialize charts
        function initCharts() {
            // Destroy existing charts if they exist
            if (verticalChart) verticalChart.destroy();
            if (categoryChart) categoryChart.destroy();
            if (termsChart) termsChart.destroy();
            
            // Count companies by vertical
            const verticalCounts = {};
            filteredData.forEach(company => {
                const vertical = company.vertical;
                if (vertical) {
                    verticalCounts[vertical] = (verticalCounts[vertical] || 0) + 1;
                }
            });
            
            // Sort and prepare data for vertical chart
            const sortedVerticals = Object.entries(verticalCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15); // Show top 15 verticals
            
            // Create vertical chart
            const verticalCtx = document.getElementById('verticalChart').getContext('2d');
            verticalChart = new Chart(verticalCtx, {
                type: 'bar',
                data: {
                    labels: sortedVerticals.map(v => v[0]),
                    datasets: [{
                        label: 'Number of Companies',
                        data: sortedVerticals.map(v => v[1]),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top Verticals by Number of Companies'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Companies'
                            }
                        }
                    }
                }
            });
            
            // Count by category
            const categoryCounts = {
                'Biotech/Life Sciences': 0,
                'Academic': 0,
                'Non-Biotech': 0
            };
            
            filteredData.forEach(company => {
                const vertical = company.vertical;
                if (biotechVerticals.includes(vertical)) {
                    categoryCounts['Biotech/Life Sciences']++;
                } else if (academicVerticals.includes(vertical)) {
                    categoryCounts['Academic']++;
                } else if (nonBiotechVerticals.includes(vertical)) {
                    categoryCounts['Non-Biotech']++;
                }
            });
            
            // Create category chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryCounts),
                    datasets: [{
                        data: Object.values(categoryCounts),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Distribution by Category'
                        }
                    }
                }
            });
            
            // Extract common terms from vertical details
            const terms = {};
            const stopWords = new Set(['and', 'the', 'for', 'in', 'on', 'with', 'to', 'of', 'a', 'an']);
            
            filteredData.forEach(company => {
                if (company.vertical_detail) {
                    const words = company.vertical_detail.toLowerCase()
                        .replace(/[^\w\s]/g, '')
                        .split(/\s+/)
                        .filter(word => word.length > 2 && !stopWords.has(word));
                    
                    words.forEach(word => {
                        terms[word] = (terms[word] || 0) + 1;
                    });
                }
            });
            
            // Sort and prepare data for terms chart
            const sortedTerms = Object.entries(terms)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20); // Show top 20 terms
            
            // Create terms chart
            const termsCtx = document.getElementById('termsChart').getContext('2d');
            termsChart = new Chart(termsCtx, {
                type: 'bar',
                data: {
                    labels: sortedTerms.map(t => t[0]),
                    datasets: [{
                        label: 'Frequency',
                        data: sortedTerms.map(t => t[1]),
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Top Terms in Vertical Details'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        }
                    }
                }
            });
        }

        // Initialize word clouds
        function initWordClouds() {
            // Extract terms for word clouds
            const allTerms = [];
            const biotechTerms = [];
            const nonBiotechTerms = [];
            
            // Extended stop words list
            const stopWords = new Set([
                'and', 'the', 'for', 'in', 'on', 'with', 'to', 'of', 'a', 'an', 'is', 'are', 'as', 'that', 'this',
                'be', 'by', 'or', 'it', 'its', 'at', 'from', 'has', 'have', 'had', 'was', 'were', 'will', 'would',
                'can', 'could', 'should', 'not', 'but', 'which', 'their', 'they', 'them', 'these', 'those', 'than',
                'then', 'there', 'when', 'where', 'who', 'how', 'what', 'why', 'all', 'any', 'both', 'each', 'more'
            ]);
            
            // Custom weights based on importance in biotech context
            const importantTerms = {
                'cancer': 5, 'therapeutic': 5, 'therapy': 5, 'drug': 5, 'antibody': 5, 'genomic': 5, 
                'diagnostic': 5, 'platform': 4, 'cell': 4, 'disease': 4, 'clinical': 4, 'biomarker': 4,
                'rare': 4, 'gene': 4, 'protein': 4, 'molecular': 3, 'monoclonal': 3, 'development': 3,
                'small': 3, 'large': 3, 'novel': 3, 'innovative': 3, 'advanced': 3, 'ai': 3, 'precision': 3,
                'medical': 3, 'research': 3, 'discovery': 3, 'technology': 3, 'device': 3
            };
            
            // Process vertical details
            filteredData.forEach(company => {
                if (company.vertical_detail) {
                    // Clean text and extract words
                    const words = company.vertical_detail.toLowerCase()
                        .replace(/[^\w\s-]/g, ' ')  // Keep hyphens for terms like "cell-based"
                        .split(/\s+/)
                        .filter(word => word.length > 2 && !stopWords.has(word));
                    
                    // Get phrase combinations (bigrams)
                    const bigrams = [];
                    for (let i = 0; i < words.length - 1; i++) {
                        const bigram = words[i] + ' ' + words[i+1];
                        if (bigram.length > 5) { // Only meaningful bigrams
                            bigrams.push(bigram);
                        }
                    }
                    
                    // Process words and bigrams
                    const allTokens = [...words, ...bigrams];
                    
                    allTokens.forEach(token => {
                        // Base size for tokens
                        let baseSize = 10;
                        
                        // Apply importance weighting
                        for (const [term, weight] of Object.entries(importantTerms)) {
                            if (token.includes(term)) {
                                baseSize += weight * 2;
                                break;
                            }
                        }
                        
                        // Add to all terms
                        const existingAll = allTerms.find(t => t.text === token);
                        if (existingAll) {
                            existingAll.size += baseSize;
                        } else {
                            allTerms.push({ text: token, size: baseSize });
                        }
                        
                        // Add to category-specific terms
                        if (biotechVerticals.includes(company.vertical)) {
                            const existingBio = biotechTerms.find(t => t.text === token);
                            if (existingBio) {
                                existingBio.size += baseSize;
                            } else {
                                biotechTerms.push({ text: token, size: baseSize });
                            }
                        } else if (nonBiotechVerticals.includes(company.vertical) || academicVerticals.includes(company.vertical)) {
                            const existingNonBio = nonBiotechTerms.find(t => t.text === token);
                            if (existingNonBio) {
                                existingNonBio.size += baseSize;
                            } else {
                                nonBiotechTerms.push({ text: token, size: baseSize });
                            }
                        }
                    });
                }
            });
            
            // Sort terms by size
            const sortAllTerms = allTerms.sort((a, b) => b.size - a.size);
            const sortBiotechTerms = biotechTerms.sort((a, b) => b.size - a.size);
            const sortNonBiotechTerms = nonBiotechTerms.sort((a, b) => b.size - a.size);
            
            // Create word clouds
            createWordCloud('detailsWordcloud', sortAllTerms.slice(0, 150)); // Show more terms
            createWordCloud('biotechWordcloud', sortBiotechTerms.slice(0, 100));
            createWordCloud('nonBiotechWordcloud', sortNonBiotechTerms.slice(0, 100));
        }

        // Helper function to create a word cloud
        function createWordCloud(elementId, words) {
            // Clear previous word cloud
            d3.select(`#${elementId}`).html("");
            
            const element = document.getElementById(elementId);
            const width = element.offsetWidth;
            const height = element.offsetHeight;
            
            // If no words or element not found, show error message
            if (!words || words.length === 0 || !element) {
                d3.select(`#${elementId}`)
                    .append("div")
                    .attr("class", "alert alert-warning")
                    .text("No data available for word cloud. Try adjusting your filters or upload a file with more detailed descriptions.");
                return;
            }
            
            // Color scale for word cloud
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            
            // Create the word cloud layout
            const layout = d3.layout.cloud()
                .size([width, height])
                .words(words)
                .padding(5)
                .rotate(() => (Math.random() < 0.5 ? 0 : 90))
                .fontSize(d => Math.sqrt(d.size) * 3 + 10) // Improved sizing formula
                .spiral("archimedean")
                .on("end", draw);
                
            layout.start();
            
            function draw(words) {
                const svg = d3.select(`#${elementId}`)
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);
                
                const wordCloud = svg.append("g")
                    .attr("transform", `translate(${width / 2},${height / 2})`)
                    .selectAll("text")
                    .data(words)
                    .enter()
                    .append("text")
                    .style("font-size", d => `${d.size}px`)
                    .style("font-family", "Arial, sans-serif")
                    .style("font-weight", d => d.size > 20 ? "bold" : "normal")
                    .style("fill", (d, i) => colorScale(i % 10))
                    .attr("text-anchor", "middle")
                    .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                    .text(d => d.text)
                    .on("mouseover", function() {
                        d3.select(this).transition()
                            .duration(300)
                            .style("font-size", d => `${d.size * 1.2}px`)
                            .style("cursor", "pointer")
                            .style("fill", "#ff7700");
                    })
                    .on("mouseout", function(d, i) {
                        d3.select(this).transition()
                            .duration(300)
                            .style("font-size", d => `${d.size}px`)
                            .style("fill", colorScale(i % 10));
                    })
                    .on("click", function(event, d) {
                        // Use the term to filter the data
                        document.getElementById('detailSearch').value = d.text;
                        document.getElementById('applyFiltersBtn').click();
                    });
                
                // Add tooltip that explains how to use the word cloud
                svg.append("text")
                    .attr("x", 10)
                    .attr("y", 20)
                    .attr("class", "text-muted")
                    .style("font-size", "12px")
                    .text("Click on any word to filter by that term");
            }
        }

        // Initialize insights tab
        function initInsights() {
            // Key statistics
            const totalCompanies = filteredData.length;
            const biotechCount = filteredData.filter(c => biotechVerticals.includes(c.vertical)).length;
            const academicCount = filteredData.filter(c => academicVerticals.includes(c.vertical)).length;
            const nonBiotechCount = filteredData.filter(c => nonBiotechVerticals.includes(c.vertical)).length;
            
            const verticalDistribution = {};
            filteredData.forEach(company => {
                const vertical = company.vertical;
                if (vertical) {
                    verticalDistribution[vertical] = (verticalDistribution[vertical] || 0) + 1;
                }
            });
            
            // Sort verticals by count
            const sortedVerticals = Object.entries(verticalDistribution)
                .sort((a, b) => b[1] - a[1]);
            
            const topVertical = sortedVerticals.length > 0 ? sortedVerticals[0][0] : 'None';
            const topVerticalCount = sortedVerticals.length > 0 ? sortedVerticals[0][1] : 0;
            
            // Display key statistics
            document.getElementById('keyStats').innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <div class="border-bottom pb-2 mb-2">
                            <h6>Total Companies</h6>
                            <span class="fs-4 fw-bold">${totalCompanies}</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border-bottom pb-2 mb-2">
                            <h6>Top Vertical</h6>
                            <span class="fs-4 fw-bold">${topVertical} (${topVerticalCount})</span>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-4">
                        <div class="text-center">
                            <h6>Biotech</h6>
                            <div class="fs-4 fw-bold">${biotechCount}</div>
                            <div class="text-muted">${Math.round(biotechCount / totalCompanies * 100)}%</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <h6>Academic</h6>
                            <div class="fs-4 fw-bold">${academicCount}</div>
                            <div class="text-muted">${Math.round(academicCount / totalCompanies * 100)}%</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="text-center">
                            <h6>Non-Biotech</h6>
                            <div class="fs-4 fw-bold">${nonBiotechCount}</div>
                            <div class="text-muted">${Math.round(nonBiotechCount / totalCompanies * 100)}%</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Populate vertical terms select
            const verticalTermsSelect = document.getElementById('verticalTermsSelect');
            verticalTermsSelect.innerHTML = '';
            
            sortedVerticals.forEach(([vertical, count]) => {
                const option = document.createElement('option');
                option.value = vertical;
                option.textContent = `${vertical} (${count})`;
                verticalTermsSelect.appendChild(option);
            });
            
            // Show terms for first vertical by default
            if (sortedVerticals.length > 0) {
                showVerticalTerms(sortedVerticals[0][0]);
            }
            
            // Add event listener for select change
            verticalTermsSelect.addEventListener('change', function() {
                showVerticalTerms(this.value);
            });
        }

        // Show common terms for a specific vertical
        function showVerticalTerms(vertical) {
            const verticalCompanies = filteredData.filter(c => c.vertical === vertical);
            const terms = {};
            const stopWords = new Set(['and', 'the', 'for', 'in', 'on', 'with', 'to', 'of', 'a', 'an']);
            
            verticalCompanies.forEach(company => {
                if (company.vertical_detail) {
                    const words = company.vertical_detail.toLowerCase()
                        .replace(/[^\w\s]/g, '')
                        .split(/\s+/)
                        .filter(word => word.length > 2 && !stopWords.has(word));
                    
                    words.forEach(word => {
                        terms[word] = (terms[word] || 0) + 1;
                    });
                }
            });
            
            // Sort and prepare data for terms
            const sortedTerms = Object.entries(terms)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15); // Show top 15 terms
            
            // Create terms list
            const termsList = document.getElementById('verticalTermsList');
            if (sortedTerms.length === 0) {
                termsList.innerHTML = '<div class="alert alert-info">No common terms found for this vertical.</div>';
                return;
            }
            
            let termsHtml = '<div class="list-group">';
            sortedTerms.forEach(([term, count]) => {
                termsHtml += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        ${term}
                        <span class="badge bg-primary rounded-pill">${count}</span>
                    </div>
                `;
            });
            termsHtml += '</div>';
            
            termsList.innerHTML = termsHtml;
        }

        // Apply filters to data
        function applyFilters() {
            const verticalFilter = document.getElementById('verticalFilter').value;
            const detailSearch = document.getElementById('detailSearch').value.toLowerCase();
            
            // Filter data
            filteredData = companiesData.filter(company => {
                // Apply vertical filter
                if (verticalFilter !== 'all' && company.vertical !== verticalFilter) {
                    return false;
                }
                
                // Apply detail search
                if (detailSearch && company.vertical_detail && !company.vertical_detail.toLowerCase().includes(detailSearch)) {
                    return false;
                }
                
                return true;
            });
            
            // Update results count
            document.getElementById('resultsCount').textContent = `Showing ${filteredData.length} of ${companiesData.length} companies`;
            
            // Update visualizations
            initDataTable();
            initCharts();
            initWordClouds();
            initInsights();
        }

        // Process CSV data
        function processData(data) {
            companiesData = data;
            filteredData = data;
            
            // Update results count
            document.getElementById('resultsCount').textContent = `Showing ${filteredData.length} of ${companiesData.length} companies`;
            
            // Initialize all visualizations
            initDataTable();
            initCharts();
            initWordClouds();
            initInsights();
            
            // Show dashboard content
            document.getElementById('dashboardContent').classList.remove('d-none');
        }

        // Parse CSV file
        function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const csv = e.target.result;
                    
                    Papa.parse(csv, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            resolve(results.data);
                        },
                        error: function(error) {
                            reject(error);
                        }
                    });
                };
                
                reader.onerror = function() {
                    reject(new Error('Error reading file'));
                };
                
                reader.readAsText(file);
            });
        }

        // Load sample data
        function loadSampleData() {
            // Create sample data with 50 companies
            const sampleData = [
                { "Company Name": "BioPharma Inc", "Company URL": "https://biopharma.example.com", "vertical": "Therapeutics", "vertical_detail": "Developing antibody-based therapies for cancer and autoimmune diseases" },
                { "Company Name": "GeneTech Solutions", "Company URL": "https://genetech.example.com", "vertical": "Therapeutics", "vertical_detail": "Gene therapy platform focused on rare genetic disorders" },
                { "Company Name": "MediDev Corp", "Company URL": "https://medidev.example.com", "vertical": "Medical Devices", "vertical_detail": "Wearable monitoring devices for cardiovascular patients" },
                { "Company Name": "LabTools Pro", "Company URL": "https://labtoolspro.example.com", "vertical": "Research Tools & Lab Equipment", "vertical_detail": "Advanced flow cytometry instruments for research laboratories" },
                { "Company Name": "Diagnostic Precision", "Company URL": "https://diagnosticprecision.example.com", "vertical": "Diagnostics", "vertical_detail": "Molecular diagnostic tests for infectious diseases" },
                { "Company Name": "BioDataSystems", "Company URL": "https://biodatasystems.example.com", "vertical": "Bioinformatics & Computational Tools", "vertical_detail": "AI-driven drug discovery platform for target identification" },
                { "Company Name": "CellCore Therapeutics", "Company URL": "https://cellcore.example.com", "vertical": "Therapeutics", "vertical_detail": "CAR-T cell therapy development for solid tumors" },
                { "Company Name": "HealthTech Solutions", "Company URL": "https://healthtech.example.com", "vertical": "Digital Health & Health IT", "vertical_detail": "Telemedicine platform with AI-assisted diagnostics" },
                { "Company Name": "LabEquip Supply", "Company URL": "https://labequip.example.com", "vertical": "Research Tools & Lab Equipment", "vertical_detail": "Laboratory consumables and reagents for genomics research" },
                { "Company Name": "BioManufacturing Inc", "Company URL": "https://biomanufacturing.example.com", "vertical": "CROs & CDMOs", "vertical_detail": "Contract manufacturing of biologics and cell therapies" },
                { "Company Name": "State University Medical Center", "Company URL": "https://sumc.example.edu", "vertical": "Academic & Research Institutions", "vertical_detail": "Research institution - Neuroscience and genomics" },
                { "Company Name": "MedConsult Partners", "Company URL": "https://medconsult.example.com", "vertical": "Clinical & Regulatory Consulting", "vertical_detail": "Regulatory strategy for biologics and advanced therapies" },
                { "Company Name": "Advanced Protein Systems", "Company URL": "https://advancedprotein.example.com", "vertical": "Research Tools & Lab Equipment", "vertical_detail": "Protein analysis tools and antibody production services" },
                { "Company Name": "NanoMed Technologies", "Company URL": "https://nanomed.example.com", "vertical": "Therapeutics", "vertical_detail": "Nanoparticle drug delivery for cancer therapeutics" },
                { "Company Name": "BioIndustrial Products", "Company URL": "https://bioindustrial.example.com", "vertical": "Industrial Biotech", "vertical_detail": "Enzymatic processes for sustainable chemical manufacturing" },
                { "Company Name": "Medical Imaging Innovations", "Company URL": "https://medicalimaging.example.com", "vertical": "Diagnostics", "vertical_detail": "Advanced imaging technology for early cancer detection" },
                { "Company Name": "Tech Solutions Inc", "Company URL": "https://techsolutions.example.com", "vertical": "Technology/IT", "vertical_detail": "Enterprise software solutions for healthcare organizations" },
                { "Company Name": "BioPharma Consultants", "Company URL": "https://biopharmaconsultants.example.com", "vertical": "Professional Services", "vertical_detail": "Business strategy consulting for biotech startups" },
                { "Company Name": "Healthcare Network", "Company URL": "https://healthcarenetwork.example.com", "vertical": "Healthcare Services", "vertical_detail": "Specialized clinics for chronic disease management" },
                { "Company Name": "Implant Technologies", "Company URL": "https://implanttech.example.com", "vertical": "Medical Devices", "vertical_detail": "Bioresorbable implants for orthopedic applications" },
                // Add more sample data to make 50 entries
                { "Company Name": "RNA Therapeutics", "Company URL": "https://rnatherapeutics.example.com", "vertical": "Therapeutics", "vertical_detail": "siRNA-based therapeutics for liver diseases" },
                { "Company Name": "Genomic Diagnostics Lab", "Company URL": "https://genomicdiagnostics.example.com", "vertical": "Diagnostics", "vertical_detail": "Next-generation sequencing tests for oncology" },
                { "Company Name": "Clinical Trial Services", "Company URL": "https://clinicaltrialservices.example.com", "vertical": "CROs & CDMOs", "vertical_detail": "Clinical trial management for phase I-III studies" },
                { "Company Name": "BioInformatics Solutions", "Company URL": "https://bioinformatics.example.com", "vertical": "Bioinformatics & Computational Tools", "vertical_detail": "Genomic data analysis software for research labs" },
                { "Company Name": "Patient Monitoring Systems", "Company URL": "https://patientmonitoring.example.com", "vertical": "Digital Health & Health IT", "vertical_detail": "Remote patient monitoring for chronic conditions" },
                { "Company Name": "Synthetic Biology Corp", "Company URL": "https://syntheticbiology.example.com", "vertical": "General Biotech", "vertical_detail": "Engineered microorganisms for various applications" },
                { "Company Name": "Bioethanol Production", "Company URL": "https://bioethanol.example.com", "vertical": "Industrial Biotech", "vertical_detail": "Bioprocessing for sustainable fuel production" },
                { "Company Name": "Research Institute of Biology", "Company URL": "https://researchbiology.example.org", "vertical": "Academic & Research Institutions", "vertical_detail": "Research institution - Systems biology and synthetic biology" },
                { "Company Name": "Surgical Instruments Co", "Company URL": "https://surgicalinstruments.example.com", "vertical": "Medical Devices", "vertical_detail": "Minimally invasive surgical tools with robotics" },
                { "Company Name": "Health Insurance Provider", "Company URL": "https://healthinsurance.example.com", "vertical": "Healthcare Services", "vertical_detail": "Health insurance plans with preventive care focus" },
                { "Company Name": "Laboratory Software", "Company URL": "https://labsoftware.example.com", "vertical": "Technology/IT", "vertical_detail": "LIMS and laboratory workflow management software" },
                { "Company Name": "Biotech Legal Advisors", "Company URL": "https://biotechlegal.example.com", "vertical": "Professional Services", "vertical_detail": "IP protection and patenting for biotech innovations" },
                { "Company Name": "Sustainable Materials", "Company URL": "https://sustainablematerials.example.com", "vertical": "Manufacturing", "vertical_detail": "Bio-based materials for packaging applications" },
                { "Company Name": "Natural Products Co", "Company URL": "https://naturalproducts.example.com", "vertical": "Consumer Goods", "vertical_detail": "Plant-based nutritional supplements and cosmetics" },
                { "Company Name": "Biotech Venture Capital", "Company URL": "https://biotechvc.example.com", "vertical": "Financial Services", "vertical_detail": "Investment fund focused on early-stage biotech startups" },
                { "Company Name": "Bioenergy Solutions", "Company URL": "https://bioenergy.example.com", "vertical": "Energy", "vertical_detail": "Biofuel production from agricultural waste" },
                { "Company Name": "Life Science Media", "Company URL": "https://lifesciencemedia.example.com", "vertical": "Media & Entertainment", "vertical_detail": "Digital publication covering biotech industry news" },
                { "Company Name": "Public Health Department", "Company URL": "https://publichealth.example.gov", "vertical": "Government & Public Sector", "vertical_detail": "Government agency for disease prevention and health promotion" },
                { "Company Name": "Waste Recycling Biotech", "Company URL": "https://wasterecycling.example.com", "vertical": "Environmental Services", "vertical_detail": "Biotechnology for waste treatment and recycling" },
                { "Company Name": "Pharma Manufacturing Facility", "Company URL": "https://pharmamanufacturing.example.com", "vertical": "Real Estate & Construction", "vertical_detail": "GMP-compliant facility design and construction for pharmaceuticals" },
                { "Company Name": "Biotech Training Institute", "Company URL": "https://biotechtraining.example.com", "vertical": "Education & Training", "vertical_detail": "Professional development courses for biotech workforce" },
                { "Company Name": "Biologics Logistics", "Company URL": "https://biologicslogistics.example.com", "vertical": "Transportation & Logistics", "vertical_detail": "Cold chain logistics for biological samples and therapies" },
                { "Company Name": "Rare Disease Foundation", "Company URL": "https://raredisease.example.org", "vertical": "Non-Profit & Advocacy", "vertical_detail": "Patient advocacy and research funding for rare genetic disorders" },
                { "Company Name": "Therapeutic Antibodies", "Company URL": "https://therapeuticantibodies.example.com", "vertical": "Therapeutics", "vertical_detail": "Monoclonal antibody development for oncology" },
                { "Company Name": "Protein Engineering", "Company URL": "https://proteinengineering.example.com", "vertical": "Therapeutics", "vertical_detail": "Engineered protein therapeutics for metabolic disorders" },
                { "Company Name": "Drug Discovery Tools", "Company URL": "https://drugdiscoverytools.example.com", "vertical": "Research Tools & Lab Equipment", "vertical_detail": "High-throughput screening platforms for drug discovery" },
                { "Company Name": "Companion Diagnostics", "Company URL": "https://companiondiagnostics.example.com", "vertical": "Diagnostics", "vertical_detail": "Biomarker tests for precision medicine applications" },
                { "Company Name": "Medical Wearables", "Company URL": "https://medicalwearables.example.com", "vertical": "Medical Devices", "vertical_detail": "Continuous glucose monitoring devices for diabetes management" },
                { "Company Name": "Drug Development Services", "Company URL": "https://drugdevelopment.example.com", "vertical": "CROs & CDMOs", "vertical_detail": "Preclinical testing and drug formulation services" },
                { "Company Name": "Genomic Informatics", "Company URL": "https://genomicinformatics.example.com", "vertical": "Bioinformatics & Computational Tools", "vertical_detail": "Population genomics and variant interpretation software" }
            ];
            
            // Show loading spinner
            document.querySelector('.loading').style.display = 'block';
            
            // Process sample data
            setTimeout(() => {
                processData(sampleData);
                document.querySelector('.loading').style.display = 'none';
                document.getElementById('uploadStatus').textContent = 'Sample data loaded successfully!';
                document.getElementById('uploadStatus').classList.remove('d-none', 'alert-danger');
                document.getElementById('uploadStatus').classList.add('alert-success');
            }, 500);
        }

        // Initialize advanced analysis visualizations
        function initAdvancedAnalysis() {
            // Vertical detail length by category chart
            const lengthByCategory = {
                'Biotech/Life Sciences': [],
                'Academic': [],
                'Non-Biotech': []
            };
            
            filteredData.forEach(company => {
                const detail = company.vertical_detail || '';
                if (biotechVerticals.includes(company.vertical)) {
                    lengthByCategory['Biotech/Life Sciences'].push(detail.length);
                } else if (academicVerticals.includes(company.vertical)) {
                    lengthByCategory['Academic'].push(detail.length);
                } else if (nonBiotechVerticals.includes(company.vertical)) {
                    lengthByCategory['Non-Biotech'].push(detail.length);
                }
            });
            
            // Calculate average lengths
            const avgLengths = {};
            for (const [category, lengths] of Object.entries(lengthByCategory)) {
                avgLengths[category] = lengths.length ? lengths.reduce((sum, length) => sum + length, 0) / lengths.length : 0;
            }
            
            // Create chart
            const lengthCtx = document.getElementById('detailLengthChart').getContext('2d');
            if (window.detailLengthChart) {
                window.detailLengthChart.destroy();
            }
            
            window.detailLengthChart = new Chart(lengthCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(avgLengths),
                    datasets: [{
                        label: 'Average Detail Length (characters)',
                        data: Object.values(avgLengths),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Length (characters)'
                            }
                        }
                    }
                }
            });
            
            // Populate vertical comparison dropdowns
            const uniqueVerticals = [...new Set(filteredData.map(c => c.vertical))].filter(v => v);
            const dropdown1 = document.getElementById('compareVertical1');
            const dropdown2 = document.getElementById('compareVertical2');
            
            dropdown1.innerHTML = '';
            dropdown2.innerHTML = '';
            
            uniqueVerticals.forEach(vertical => {
                dropdown1.appendChild(new Option(vertical, vertical));
                dropdown2.appendChild(new Option(vertical, vertical));
            });
            
            // Set second dropdown to second option if available
            if (uniqueVerticals.length > 1) {
                dropdown2.selectedIndex = 1;
            }
            
            // Add event listener for comparison button
            document.getElementById('compareVerticalsBtn').addEventListener('click', function() {
                compareVerticals(dropdown1.value, dropdown2.value);
            });
            
            // Add event listener for term search button
            document.getElementById('searchTermBtn').addEventListener('click', function() {
                const term = document.getElementById('termSearch').value.trim().toLowerCase();
                if (term) {
                    showTermDistribution(term);
                }
            });
            
            // Initialize sentiment analysis chart
            initSentimentAnalysis();
        }
        
        // Compare two verticals
        function compareVerticals(vertical1, vertical2) {
            if (vertical1 === vertical2) {
                document.getElementById('comparisonResult').innerHTML = '<div class="alert alert-warning">Please select two different verticals to compare.</div>';
                return;
            }
            
            const companies1 = filteredData.filter(c => c.vertical === vertical1);
            const companies2 = filteredData.filter(c => c.vertical === vertical2);
            
            if (companies1.length === 0 || companies2.length === 0) {
                document.getElementById('comparisonResult').innerHTML = '<div class="alert alert-warning">Not enough data for one or both verticals.</div>';
                return;
            }
            
            // Extract terms from each vertical
            const terms1 = {};
            const terms2 = {};
            const stopWords = new Set(['and', 'the', 'for', 'in', 'on', 'with', 'to', 'of', 'a', 'an', 'is', 'are']);
            
            companies1.forEach(company => {
                if (company.vertical_detail) {
                    const words = company.vertical_detail.toLowerCase()
                        .replace(/[^\w\s]/g, '')
                        .split(/\s+/)
                        .filter(word => word.length > 2 && !stopWords.has(word));
                    
                    words.forEach(word => {
                        terms1[word] = (terms1[word] || 0) + 1;
                    });
                }
            });
            
            companies2.forEach(company => {
                if (company.vertical_detail) {
                    const words = company.vertical_detail.toLowerCase()
                        .replace(/[^\w\s]/g, '')
                        .split(/\s+/)
                        .filter(word => word.length > 2 && !stopWords.has(word));
                    
                    words.forEach(word => {
                        terms2[word] = (terms2[word] || 0) + 1;
                    });
                }
            });
            
            // Find common and unique terms
            const commonTerms = [];
            const uniqueToFirst = [];
            const uniqueToSecond = [];
            
            for (const [term, count] of Object.entries(terms1)) {
                if (terms2[term]) {
                    commonTerms.push({ term, count1: count, count2: terms2[term] });
                } else {
                    uniqueToFirst.push({ term, count });
                }
            }
            
            for (const [term, count] of Object.entries(terms2)) {
                if (!terms1[term]) {
                    uniqueToSecond.push({ term, count });
                }
            }
            
            // Sort terms by frequency
            commonTerms.sort((a, b) => (b.count1 + b.count2) - (a.count1 + a.count2));
            uniqueToFirst.sort((a, b) => b.count - a.count);
            uniqueToSecond.sort((a, b) => b.count - a.count);
            
            // Create comparison display
            let html = `
                <div class="mb-4">
                    <h5>Comparison: ${vertical1} vs ${vertical2}</h5>
                    <p><strong>${companies1.length}</strong> companies in ${vertical1}, <strong>${companies2.length}</strong> companies in ${vertical2}</p>
                </div>
                
                <div class="mb-4">
                    <h6>Common Terms:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Term</th>
                                    <th>${vertical1} Count</th>
                                    <th>${vertical2} Count</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            commonTerms.slice(0, 10).forEach(item => {
                html += `
                    <tr>
                        <td>${item.term}</td>
                        <td>${item.count1}</td>
                        <td>${item.count2}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Unique to ${vertical1}:</h6>
                        <ul class="list-group">
            `;
            
            uniqueToFirst.slice(0, 10).forEach(item => {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${item.term} <span class="badge bg-primary rounded-pill">${item.count}</span>
                </li>`;
            });
            
            html += `
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Unique to ${vertical2}:</h6>
                        <ul class="list-group">
            `;
            
            uniqueToSecond.slice(0, 10).forEach(item => {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${item.term} <span class="badge bg-primary rounded-pill">${item.count}</span>
                </li>`;
            });
            
            html += `
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('comparisonResult').innerHTML = html;
        }
        
        // Show term distribution across verticals
        function showTermDistribution(searchTerm) {
            const verticalCounts = {};
            const allVerticals = [...biotechVerticals, ...academicVerticals, ...nonBiotechVerticals];
            
            // Initialize counts
            allVerticals.forEach(v => {
                verticalCounts[v] = 0;
            });
            
            // Count occurrences by vertical
            filteredData.forEach(company => {
                if (company.vertical_detail && company.vertical_detail.toLowerCase().includes(searchTerm)) {
                    verticalCounts[company.vertical] = (verticalCounts[company.vertical] || 0) + 1;
                }
            });
            
            // Sort by count
            const sortedVerticals = Object.entries(verticalCounts)
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1]);
            
            // Create/update chart
            const ctx = document.getElementById('termDistributionChart').getContext('2d');
            
            if (window.termDistributionChart) {
                window.termDistributionChart.destroy();
            }
            
            window.termDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedVerticals.map(v => v[0]),
                    datasets: [{
                        label: `Companies mentioning "${searchTerm}"`,
                        data: sortedVerticals.map(v => v[1]),
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Distribution of "${searchTerm}" across verticals`
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Companies'
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize sentiment analysis
        function initSentimentAnalysis() {
            // Simple sentiment dictionary
            const posWords = new Set([
                'innovative', 'advanced', 'novel', 'leading', 'precision', 'effective', 'efficient',
                'revolutionary', 'specialized', 'comprehensive', 'unique', 'cutting-edge', 'state-of-the-art',
                'integrated', 'premier', 'powerful', 'optimized', 'enhanced', 'robust', 'breakthrough',
                'seamless', 'strategic', 'trusted', 'expert', 'excellence', 'superior', 'accelerated'
            ]);
            
            const negWords = new Set([
                'complex', 'challenging', 'difficult', 'limited', 'experimental', 'controversial',
                'costly', 'expensive', 'rare', 'uncommon', 'investigational', 'undeveloped'
            ]);
            
            // Calculate sentiment scores by vertical
            const sentimentScores = {};
            const verticalSamples = {};
            
            allVerticals.forEach(vertical => {
                sentimentScores[vertical] = 0;
                verticalSamples[vertical] = 0;
            });
            
            filteredData.forEach(company => {
                if (company.vertical_detail && company.vertical) {
                    const words = company.vertical_detail.toLowerCase().split(/\W+/);
                    let score = 0;
                    
                    words.forEach(word => {
                        if (posWords.has(word)) score += 1;
                        if (negWords.has(word)) score -= 1;
                    });
                    
                    sentimentScores[company.vertical] = (sentimentScores[company.vertical] || 0) + score;
                    verticalSamples[company.vertical] = (verticalSamples[company.vertical] || 0) + 1;
                }
            });
            
            // Calculate average scores
            const verticals = [];
            const scores = [];
            
            Object.entries(sentimentScores).forEach(([vertical, score]) => {
                if (verticalSamples[vertical] > 0) {
                    verticals.push(vertical);
                    scores.push(score / verticalSamples[vertical]);
                }
            });
            
            // Sort by score
            const sortedData = verticals.map((v, i) => ({ vertical: v, score: scores[i] }))
                .sort((a, b) => b.score - a.score);
            
            // Create sentiment chart
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            if (window.sentimentChart) {
                window.sentimentChart.destroy();
            }
            
            window.sentimentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(d => d.vertical),
                    datasets: [{
                        label: 'Sentiment Score',
                        data: sortedData.map(d => d.score),
                        backgroundColor: sortedData.map(d => d.score >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                        borderColor: sortedData.map(d => d.score >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Sentiment Score (higher = more positive language)'
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize network analysis
        function initNetworkAnalysis() {
            // Extract terms for co-occurrence network
            const terms = {};
            const cooccurrences = {};
            
            // Extended stopwords
            const stopWords = new Set([
                'and', 'the', 'for', 'in', 'on', 'with', 'to', 'of', 'a', 'an', 'is', 'are', 'as', 'that', 'this',
                'be', 'by', 'or', 'it', 'its', 'at', 'from', 'has', 'have', 'had', 'was', 'were', 'will', 'would',
                'can', 'could', 'should', 'not', 'but', 'which', 'their', 'they', 'them', 'these', 'those'
            ]);
            
            // Process terms from vertical details
            filteredData.forEach(company => {
                if (company.vertical_detail) {
                    // Extract significant words
                    const words = company.vertical_detail.toLowerCase()
                        .replace(/[^\w\s-]/g, ' ')
                        .split(/\s+/)
                        .filter(word => word.length > 3 && !stopWords.has(word));
                    
                    // Record term frequencies
                    words.forEach(word => {
                        terms[word] = (terms[word] || 0) + 1;
                    });
                    
                    // Record co-occurrences
                    for (let i = 0; i < words.length; i++) {
                        for (let j = i + 1; j < words.length; j++) {
                            const term1 = words[i];
                            const term2 = words[j];
                            
                            // Use a consistent key format for pairs
                            const pair = [term1, term2].sort().join('__');
                            
                            if (!cooccurrences[pair]) {
                                cooccurrences[pair] = {
                                    source: term1,
                                    target: term2,
                                    value: 0
                                };
                            }
                            
                            cooccurrences[pair].value += 1;
                        }
                    }
                }
            });
            
            // Filter to most common terms
            const topTerms = Object.entries(terms)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50)
                .map(([term]) => term);
            
            const topTermsSet = new Set(topTerms);
            
            // Create network data
            const nodes = topTerms.map(term => ({
                id: term,
                group: 1, // Will be updated by community detection
                value: terms[term]
            }));
            
            const links = Object.values(cooccurrences)
                .filter(link => topTermsSet.has(link.source) && topTermsSet.has(link.target) && link.value > 1)
                .map(link => ({ ...link }));
            
            // Apply community detection (clustering)
            if (typeof jLouvain !== 'undefined' && nodes.length > 0 && links.length > 0) {
                try {
                    // Prepare data for jLouvain
                    const nodeData = {};
                    nodes.forEach(node => {
                        nodeData[node.id] = node;
                    });
                    
                    const edgeData = links.map(link => ({
                        source: link.source,
                        target: link.target,
                        weight: link.value
                    }));
                    
                    // Run community detection
                    const community = jLouvain().nodes(nodeData).edges(edgeData);
                    const result = community();
                    
                    // Assign communities to nodes
                    nodes.forEach(node => {
                        node.group = result[node.id] || 0;
                    });
                    
                    // Group terms by cluster for term clusters view
                    const clusters = {};
                    nodes.forEach(node => {
                        if (!clusters[node.group]) {
                            clusters[node.group] = [];
                        }
                        clusters[node.group].push({
                            term: node.id,
                            value: node.value
                        });
                    });
                    
                    // Sort clusters by size
                    Object.keys(clusters).forEach(group => {
                        clusters[group].sort((a, b) => b.value - a.value);
                    });
                    
                    // Display term clusters
                    let clusterHtml = '<div class="accordion" id="clusterAccordion">';
                    Object.entries(clusters).forEach(([group, terms], index) => {
                        const isOpen = index === 0 ? 'show' : '';
                        const isExpanded = index === 0 ? 'true' : 'false';
                        
                        clusterHtml += `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading${group}">
                                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${group}" aria-expanded="${isExpanded}" aria-controls="collapse${group}">
                                        Cluster ${+group + 1} (${terms.length} terms)
                                    </button>
                                </h2>
                                <div id="collapse${group}" class="accordion-collapse collapse ${isOpen}" aria-labelledby="heading${group}">
                                    <div class="accordion-body">
                                        <div class="d-flex flex-wrap gap-1">
                        `;
                        
                        terms.forEach(term => {
                            const fontSize = Math.max(10, Math.min(18, 10 + term.value / 2));
                            clusterHtml += `<span class="badge bg-light text-dark me-1 mb-1" style="font-size: ${fontSize}px;">${term.term} (${term.value})</span>`;
                        });
                        
                        clusterHtml += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    clusterHtml += '</div>';
                    document.getElementById('termClusters').innerHTML = clusterHtml;
                } catch (e) {
                    console.error("Error in community detection:", e);
                    document.getElementById('termClusters').innerHTML = '<div class="alert alert-danger">Error generating term clusters.</div>';
                }
            } else {
                document.getElementById('termClusters').innerHTML = '<div class="alert alert-warning">Not enough data to generate term clusters.</div>';
            }
            
            // Generate the force-directed graph
            const graphData = {
                nodes,
                links
            };
            
            // Color scale for communities
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            
            // Clear previous graph
            document.getElementById('networkGraph').innerHTML = '';
            
            // Check if we have data to display
            if (nodes.length === 0 || links.length === 0) {
                document.getElementById('networkGraph').innerHTML = '<div class="alert alert-warning">Not enough data to generate the network graph.</div>';
                return;
            }
            
            // Create force-directed graph
            const Graph = ForceGraph()
                (document.getElementById('networkGraph'))
                .graphData(graphData)
                .nodeId('id')
                .nodeVal('value')
                .nodeLabel(node => `${node.id} (mentioned ${node.value} times)`)
                .nodeColor(node => colorScale(node.group))
                .linkWidth(link => Math.sqrt(link.value))
                .linkDirectionalParticles(2)
                .linkDirectionalParticleWidth(link => Math.sqrt(link.value) * 0.5)
                .onNodeClick(node => {
                    // When a node is clicked, search for that term
                    document.getElementById('termSearch').value = node.id;
                    document.getElementById('searchTermBtn').click();
                    
                    // Switch to the advanced tab if not already there
                    const advancedTab = document.getElementById('advanced-tab');
                    const tabInstance = new bootstrap.Tab(advancedTab);
                    tabInstance.show();
                });
            
            // Generate vertical similarity map
            initVerticalSimilarityMap();
        }
        
        // Create a similarity map of verticals based on term usage
        function initVerticalSimilarityMap() {
            // Get verticals with enough data
            const verticalData = [];
            const minCompanies = 2; // Minimum companies per vertical to include
            
            // Count companies per vertical
            const verticalCounts = {};
            filteredData.forEach(company => {
                if (company.vertical) {
                    verticalCounts[company.vertical] = (verticalCounts[company.vertical] || 0) + 1;
                }
            });
            
            // Extract term vectors for each vertical
            const verticalTerms = {};
            const allTerms = new Set();
            
            // Process terms by vertical
            filteredData.forEach(company => {
                if (company.vertical_detail && company.vertical && verticalCounts[company.vertical] >= minCompanies) {
                    if (!verticalTerms[company.vertical]) {
                        verticalTerms[company.vertical] = {};
                    }
                    
                    // Extract terms
                    const words = company.vertical_detail.toLowerCase()
                        .replace(/[^\w\s-]/g, ' ')
                        .split(/\s+/)
                        .filter(word => word.length > 3);
                    
                    // Record terms
                    words.forEach(word => {
                        allTerms.add(word);
                        verticalTerms[company.vertical][word] = (verticalTerms[company.vertical][word] || 0) + 1;
                    });
                }
            });
            
            // Not enough data
            if (Object.keys(verticalTerms).length < 3) {
                document.getElementById('verticalClusterMap').innerHTML = 
                    '<div class="alert alert-warning">Not enough data to generate the similarity map.</div>';
                return;
            }
            
            // Convert to vectors
            const termsList = Array.from(allTerms);
            const verticalVectors = {};
            
            Object.entries(verticalTerms).forEach(([vertical, terms]) => {
                verticalVectors[vertical] = Array(termsList.length).fill(0);
                
                Object.entries(terms).forEach(([term, count]) => {
                    const index = termsList.indexOf(term);
                    if (index !== -1) {
                        verticalVectors[vertical][index] = count;
                    }
                });
            });
            
            // Calculate similarities
            const similarities = [];
            const verticals = Object.keys(verticalVectors);
            
            for (let i = 0; i < verticals.length; i++) {
                for (let j = i + 1; j < verticals.length; j++) {
                    const vertical1 = verticals[i];
                    const vertical2 = verticals[j];
                    
                    // Calculate cosine similarity
                    const vec1 = verticalVectors[vertical1];
                    const vec2 = verticalVectors[vertical2];
                    
                    let dotProduct = 0;
                    let norm1 = 0;
                    let norm2 = 0;
                    
                    for (let k = 0; k < vec1.length; k++) {
                        dotProduct += vec1[k] * vec2[k];
                        norm1 += vec1[k] * vec1[k];
                        norm2 += vec2[k] * vec2[k];
                    }
                    
                    norm1 = Math.sqrt(norm1);
                    norm2 = Math.sqrt(norm2);
                    
                    const similarity = norm1 && norm2 ? dotProduct / (norm1 * norm2) : 0;
                    
                    if (similarity > 0.1) { // Minimum similarity threshold
                        similarities.push({
                            source: vertical1,
                            target: vertical2,
                            value: similarity
                        });
                    }
                }
            }
            
            // Create graph data
            const nodes = verticals.map(vertical => ({
                id: vertical,
                group: biotechVerticals.includes(vertical) ? 1 : (academicVerticals.includes(vertical) ? 2 : 3),
                count: verticalCounts[vertical] || 0
            }));
            
            const links = similarities;
            
            // Color scale for groups
            const colorScale = d3.scaleOrdinal()
                .domain([1, 2, 3])
                .range(['#4e79a7', '#f28e2c', '#76b7b2']);
            
            // Clear previous graph
            document.getElementById('verticalClusterMap').innerHTML = '';
            
            // Create force-directed graph
            const Graph = ForceGraph()
                (document.getElementById('verticalClusterMap'))
                .graphData({ nodes, links })
                .nodeId('id')
                .nodeVal('count')
                .nodeLabel(node => `${node.id} (${node.count} companies)`)
                .nodeColor(node => colorScale(node.group))
                .linkWidth(link => link.value * 5)
                .linkLabel(link => `Similarity: ${Math.round(link.value * 100)}%`)
                .onNodeClick(node => {
                    // Set this vertical in the comparison tool
                    document.getElementById('compareVertical1').value = node.id;
                    // Trigger comparison if a different vertical is already selected in the second dropdown
                    const dropdown2 = document.getElementById('compareVertical2');
                    if (dropdown2.value !== node.id) {
                        document.getElementById('compareVerticalsBtn').click();
                    }
                })
                .zoomToFit();
        }
        
        // Update process data to include all visualizations
        const originalProcessData = processData;
        processData = function(data) {
            originalProcessData(data);
            initAdvancedAnalysis();
            initNetworkAnalysis();
        };
        
        // Document ready
        document.addEventListener('DOMContentLoaded', function() {
            // Load CSV button click handler
            document.getElementById('loadCsvBtn').addEventListener('click', function() {
                const fileInput = document.getElementById('csvFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    document.getElementById('uploadStatus').textContent = 'Please select a CSV file first.';
                    document.getElementById('uploadStatus').classList.remove('d-none', 'alert-success');
                    document.getElementById('uploadStatus').classList.add('alert-danger');
                    return;
                }
                
                // Show loading spinner
                document.querySelector('.loading').style.display = 'block';
                
                // Parse CSV file
                parseCSV(file)
                    .then(data => {
                        if (data.length === 0) {
                            throw new Error('No data found in CSV file.');
                        }
                        
                        // Process data
                        processData(data);
                        
                        // Update status
                        document.getElementById('uploadStatus').textContent = 'CSV file loaded successfully!';
                        document.getElementById('uploadStatus').classList.remove('d-none', 'alert-danger');
                        document.getElementById('uploadStatus').classList.add('alert-success');
                    })
                    .catch(error => {
                        document.getElementById('uploadStatus').textContent = `Error: ${error.message}`;
                        document.getElementById('uploadStatus').classList.remove('d-none', 'alert-success');
                        document.getElementById('uploadStatus').classList.add('alert-danger');
                    })
                    .finally(() => {
                        document.querySelector('.loading').style.display = 'none';
                    });
            });
            
            // Load sample data button click handler
            document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
            
            // Apply filters button click handler
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            
            // Reset filters button click handler
            document.getElementById('resetFiltersBtn').addEventListener('click', function() {
                document.getElementById('verticalFilter').value = 'all';
                document.getElementById('detailSearch').value = '';
                
                // Reset filters
                filteredData = companiesData;
                document.getElementById('resultsCount').textContent = `Showing ${filteredData.length} of ${companiesData.length} companies`;
                
                // Update visualizations
                initDataTable();
                initCharts();
                initWordClouds();
                initInsights();
                initAdvancedAnalysis();
                initNetworkAnalysis();
            });
            
            // Add tab switch handler to properly resize graphs
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    // Force resize for any charts that might be in the newly shown tab
                    window.dispatchEvent(new Event('resize'));
                });
            });
        });
    </script>
</body>
</html>
